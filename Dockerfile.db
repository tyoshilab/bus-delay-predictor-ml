# Dockerfile for GTFS PostgreSQL Database with PostGIS
# Based on Railway's official PostgreSQL template for compatibility
# Railway-compatible: Uses runtime download for dump files

# Use Railway's official PostgreSQL image (optimized for Railway environment)
FROM ghcr.io/railwayapp-templates/postgres-ssl:17

# Switch to root to install packages
USER root

# Install PostGIS and required tools
RUN apt-get update && apt-get install -y \
    postgresql-17-postgis-3 \
    postgresql-17-postgis-3-scripts \
    python3 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set environment variables
ENV POSTGRES_PASSWORD=postgres \
    POSTGRES_USER=postgres \
    POSTGRES_DB=postgres

# Create download script
RUN cat > /docker-entrypoint-initdb.d/00-download-dump.sh <<'SCRIPT_EOF'
#!/bin/bash
set -e

echo "=========================================="
echo "Checking for database dump"
echo "=========================================="

DUMP_FILE="/docker-entrypoint-initdb.d/backup.dump"

# Check if already exists
if [ -f "$DUMP_FILE" ] && [ -s "$DUMP_FILE" ]; then
  SIZE=$(stat -c%s "$DUMP_FILE" 2>/dev/null)
  if [ "$SIZE" -gt 100000 ]; then
    echo "✓ Valid dump exists ($SIZE bytes)"
    exit 0
  else
    rm -f "$DUMP_FILE"
  fi
fi

# Download if GITHUB_TOKEN is set
if [ -z "$GITHUB_TOKEN" ]; then
  echo "No GITHUB_TOKEN - database will start empty"
  exit 0
fi

echo "Downloading from GitHub..."

GITHUB_REPO="${GITHUB_REPO:-tyoshilab/bus-delay-predictor-ml}"
RELEASE_TAG="${RELEASE_TAG:-v1.0.0}"
ASSET_NAME="${ASSET_NAME:-gtfs_db.dump}"

RELEASE_API_URL="https://api.github.com/repos/$GITHUB_REPO/releases/tags/$RELEASE_TAG"

ASSET_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github.v3+json" \
  "$RELEASE_API_URL" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for asset in data.get('assets', []):
        if asset.get('name') == '$ASSET_NAME':
            print(asset.get('id'))
            break
except:
    pass
" 2>/dev/null)

if [ -z "$ASSET_ID" ]; then
  echo "✗ Asset '$ASSET_NAME' not found in release '$RELEASE_TAG'"
  exit 0
fi

ASSET_URL="https://api.github.com/repos/$GITHUB_REPO/releases/assets/$ASSET_ID"

if curl -L -f --progress-bar \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/octet-stream" \
  -o "$DUMP_FILE" \
  "$ASSET_URL"; then
  
  SIZE=$(stat -c%s "$DUMP_FILE" 2>/dev/null)
  if [ "$SIZE" -lt 100000 ]; then
    echo "✗ Downloaded file too small ($SIZE bytes)"
    rm -f "$DUMP_FILE"
  else
    echo "✓ Downloaded successfully ($SIZE bytes)"
  fi
else
  echo "✗ Download failed"
fi
SCRIPT_EOF

# Create PostGIS initialization script
RUN cat > /docker-entrypoint-initdb.d/01-enable-postgis.sh <<'SCRIPT_EOF'
#!/bin/bash
set -e
echo "===== Enabling PostGIS extension ====="
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
  CREATE EXTENSION IF NOT EXISTS postgis;
  CREATE EXTENSION IF NOT EXISTS postgis_topology;
  SELECT PostGIS_version();
EOSQL
echo "===== PostGIS enabled ====="
SCRIPT_EOF

# Create restore script
RUN cat > /docker-entrypoint-initdb.d/99-restore-dump.sh <<'SCRIPT_EOF'
#!/bin/bash
set -e
echo "===== Checking for dump file ====="
DUMP_FILE="/docker-entrypoint-initdb.d/backup.dump"

if [ -f "$DUMP_FILE" ] && [ -s "$DUMP_FILE" ]; then
  SIZE=$(stat -c%s "$DUMP_FILE" 2>/dev/null)
  echo "Dump size: $(du -h $DUMP_FILE | cut -f1) ($SIZE bytes)"

  if [ "$SIZE" -lt 100000 ]; then
    echo "ERROR: Dump file too small, skipping"
    exit 0
  fi

  echo "Starting restore: $(date)"
  JOBS=$(nproc 2>/dev/null || echo "2")
  echo "Using $JOBS parallel jobs"

  pg_restore -U "$POSTGRES_USER" -d "$POSTGRES_DB" -v --no-owner --no-acl --jobs=$JOBS "$DUMP_FILE" 2>&1 | head -100 || echo "Restore completed with warnings"

  echo "===== Restore completed: $(date) ====="

  if [ "$CLEANUP_DUMP" = "true" ]; then
    rm -f "$DUMP_FILE"
  fi
else
  echo "No valid dump file. Database will start empty."
fi
SCRIPT_EOF

# Make scripts executable
RUN chmod +x /docker-entrypoint-initdb.d/00-download-dump.sh && \
    chmod +x /docker-entrypoint-initdb.d/01-enable-postgis.sh && \
    chmod +x /docker-entrypoint-initdb.d/99-restore-dump.sh

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=5 \
  CMD pg_isready -U postgres || exit 1

# Expose PostgreSQL port
EXPOSE 5432

# NOTE: Do NOT override ENTRYPOINT or CMD
# Use defaults from Railway's postgres-ssl image
# The image is optimized for Railway's volume mounting
