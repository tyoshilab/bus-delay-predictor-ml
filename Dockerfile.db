# Multi-stage Dockerfile for GTFS PostgreSQL Database with PostGIS
# Production-ready with dump restore from GitHub resources
# Railway-compatible: Optimized for faster deployments

# Stage 1: Download dump file from GitHub
FROM alpine:latest as downloader

# Install curl with compression support
RUN apk add --no-cache curl

# Set build arguments for GitHub resource URL
ARG GITHUB_REPO_URL="https://github.com/taitalabs/vancoucer-bus-science/releases/download"
ARG DUMP_VERSION="v1.0.0"
ARG DUMP_FILENAME="gtfs_db.dump"

# Download the database dump from GitHub resources
WORKDIR /tmp
RUN echo "===== Downloading database dump from GitHub =====" && \
    echo "URL: ${GITHUB_REPO_URL}/${DUMP_VERSION}/${DUMP_FILENAME}" && \
    echo "Start time: $(date)" && \
    curl -L --progress-bar -o backup.dump \
    "${GITHUB_REPO_URL}/${DUMP_VERSION}/${DUMP_FILENAME}" || \
    (echo "Failed to download dump file. Will skip restore." && touch backup.dump) && \
    echo "Download completed: $(date)" && \
    echo "File size: $(du -h backup.dump | cut -f1)"

# Stage 2: PostgreSQL with PostGIS
FROM postgis/postgis:17-3.6-alpine

# Install required tools
RUN apk add --no-cache postgresql-client

# Set environment variables with defaults
ENV POSTGRES_PASSWORD=postgres \
    POSTGRES_USER=postgres \
    POSTGRES_DB=postgres \
    PGDATA=/var/lib/postgresql/data

# Ensure postgres user ownership and proper permissions
RUN mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql && \
    chmod -R 700 /var/lib/postgresql/data

# Create initialization directory
RUN mkdir -p /docker-entrypoint-initdb.d

# Copy dump file from downloader stage
COPY --from=downloader /tmp/backup.dump /docker-entrypoint-initdb.d/backup.dump

# Create PostGIS initialization script
RUN printf '#!/bin/sh\nset -e\necho "===== $(date): Enabling PostGIS ====="\npsql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL\nCREATE EXTENSION IF NOT EXISTS postgis;\nCREATE EXTENSION IF NOT EXISTS postgis_topology;\nSELECT PostGIS_version();\nEOSQL\necho "===== $(date): PostGIS enabled ====="\n' > /docker-entrypoint-initdb.d/00-enable-postgis.sh && \
    chmod +x /docker-entrypoint-initdb.d/00-enable-postgis.sh

# Create optimized restore script with parallel processing
RUN printf '#!/bin/sh\nset -e\necho "===== $(date): Checking dump file ====="\nDUMP_FILE="/docker-entrypoint-initdb.d/backup.dump"\nif [ -f "$DUMP_FILE" ] && [ -s "$DUMP_FILE" ]; then\n  echo "Dump size: $(du -h $DUMP_FILE | cut -f1)"\n  echo "Start restore: $(date)"\n  JOBS=$(nproc 2>/dev/null || echo "2")\n  echo "Using $JOBS parallel jobs"\n  pg_restore -U "$POSTGRES_USER" -d "$POSTGRES_DB" -v --no-owner --no-acl --jobs=$JOBS "$DUMP_FILE" 2>&1 | head -100 || echo "Restore completed with warnings"\n  echo "===== $(date): Restore completed ====="\n  [ "$CLEANUP_DUMP" = "true" ] && rm -f "$DUMP_FILE" || echo "Dump retained"\nelse\n  echo "No dump file found"\nfi\n' > /docker-entrypoint-initdb.d/99-restore-dump.sh && \
    chmod +x /docker-entrypoint-initdb.d/99-restore-dump.sh

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=5 \
  CMD pg_isready -U $POSTGRES_USER -d $POSTGRES_DB || exit 1

# Expose PostgreSQL port
EXPOSE 5432

# NOTE: VOLUME keyword is NOT used (Railway requirement)
# Configure volume via Railway Dashboard: /var/lib/postgresql/data (10GB+)

# Run as postgres user
USER postgres
