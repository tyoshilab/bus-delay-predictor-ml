# Dockerfile for GTFS PostgreSQL Database with PostGIS
# Production-ready with dump restore from GitHub private repository
# Railway-compatible: Uses runtime download instead of build-time

FROM postgis/postgis:17-3.6-alpine

# Install required tools
RUN apk add --no-cache \
    postgresql-client \
    python3 \
    curl \
    bash

# CRITICAL: Set PGDATA to subdirectory (Railway requirement)
# Railway mounts volume at /var/lib/postgresql/data as root
# PostgreSQL needs to write to a subdirectory owned by postgres
ENV POSTGRES_PASSWORD=postgres \
    POSTGRES_USER=postgres \
    POSTGRES_DB=postgres \
    PGDATA=/var/lib/postgresql/data/pgdata

# Create PostGIS initialization script
RUN cat > /docker-entrypoint-initdb.d/01-enable-postgis.sh <<'SCRIPT_EOF'
#!/bin/bash
set -e
echo "===== Enabling PostGIS extension ====="
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
  CREATE EXTENSION IF NOT EXISTS postgis;
  CREATE EXTENSION IF NOT EXISTS postgis_topology;
  SELECT PostGIS_version();
EOSQL
echo "===== PostGIS enabled ====="
SCRIPT_EOF

# Create restore script
RUN cat > /docker-entrypoint-initdb.d/99-restore-dump.sh <<'SCRIPT_EOF'
#!/bin/bash
set -e
echo "===== Checking for dump file ====="
DUMP_FILE="/docker-entrypoint-initdb.d/backup.dump"

if [ -f "$DUMP_FILE" ] && [ -s "$DUMP_FILE" ]; then
  SIZE=$(stat -c%s "$DUMP_FILE" 2>/dev/null || stat -f%z "$DUMP_FILE" 2>/dev/null)
  echo "Dump size: $(du -h $DUMP_FILE | cut -f1) ($SIZE bytes)"

  if [ "$SIZE" -lt 100000 ]; then
    echo "ERROR: Dump file too small, skipping"
    exit 0
  fi

  echo "Starting restore: $(date)"
  JOBS=$(nproc 2>/dev/null || echo "2")
  echo "Using $JOBS parallel jobs"

  pg_restore -U "$POSTGRES_USER" -d "$POSTGRES_DB" -v --no-owner --no-acl --jobs=$JOBS "$DUMP_FILE" 2>&1 | head -100 || echo "Restore completed with warnings"

  echo "===== Restore completed: $(date) ====="

  if [ "$CLEANUP_DUMP" = "true" ]; then
    rm -f "$DUMP_FILE"
  fi
else
  echo "No valid dump file. Database will start empty."
fi
SCRIPT_EOF

# Make scripts executable
RUN chmod +x /docker-entrypoint-initdb.d/01-enable-postgis.sh && \
    chmod +x /docker-entrypoint-initdb.d/99-restore-dump.sh

# Copy custom entrypoint for GitHub download and Railway volume fix
COPY db_entrypoint.sh /usr/local/bin/db_entrypoint.sh
RUN chmod +x /usr/local/bin/db_entrypoint.sh

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=5 \
  CMD pg_isready -U $POSTGRES_USER -d $POSTGRES_DB || exit 1

# Expose PostgreSQL port
EXPOSE 5432

# NOTE: VOLUME keyword is NOT used (Railway requirement)
# Railway will mount volume at /var/lib/postgresql/data
# PostgreSQL will use /var/lib/postgresql/data/pgdata

# Use custom entrypoint
ENTRYPOINT ["/usr/local/bin/db_entrypoint.sh"]
CMD ["postgres"]
