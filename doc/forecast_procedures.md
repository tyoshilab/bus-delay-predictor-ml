手順書：運行情報と気象情報の畳み込みによるバス遅延予測モデルの構築と評価
本手順書は、石長 篤人らの論文「運行情報と気象情報の畳み込みによるバス到着時刻予測手法の提案と評価」を参考に、バンクーバーのバスデータの特性に合わせて、路線バスの遅延予測モデルを実際に構築し、評価するための具体的な手順を記述します。
1. 目的と概要
• 目的: 気象情報と運行情報を統合し、畳み込みLSTM (Convolutional LSTM) を用いて、バンクーバーの路線バスの遅延時間を高精度に予測するモデルを構築・評価することです。
• 主要なアプローチ:
    ◦ 気象情報の活用: 運行データと気象データ（天候、気温、降水量）を同時に畳み込み演算に組み込み、天候に起因する運行の乱れに対応し予測精度を向上させます。気象データは取得が容易でコストが低いという利点があります。
    ◦ 走行時間と遅延時間の統合予測: バンクーバーのGTFSデータでは停車時間が直接取得できないため、走行時間（区間所要時間）と各バス停での遅延時間を組み合わせて、未来の遅延時間を予測します。
    ◦ 双方向LSTM (Bidirectional LSTM) の採用: 順方向と逆方向の伝搬により、時系列データの学習能力を向上させ、さらなる予測精度向上を目指します。
2. データ収集
モデルの学習と評価には、以下の2種類のデータが必要です。
• 2.1. 過去運行データ
    ◦ データソース: General Transit Feed Specification (GTFS) Realtime データ（バンクーバー）
    ◦ 主要な取得項目:
        ▪ actual_arrival_time: 各バス停での実際の到着時刻
        ▪ start_date: 運行日
        ▪ day_of_week: 曜日（1: 月曜日 ～ 7: 日曜日）
        ▪ route_id: 路線識別子
        ▪ direction_id: 運行方向（0: 上り、1: 下り）
        ▪ stop_sequence: 路線において始点から終点までの順方向で何番目のバス停であるか
        ▪ stop_id: バス停の識別子
        ▪ trip_id: 運行便の識別子
        ▪ travel_time_duration: 前のバス停からの走行時間（秒）- LAG関数で算出
        ▪ arrival_delay: 時刻表に対する遅延時間（秒）- 正の値が遅延、負の値が早着
    ◦ 特徴: バンクーバーのGTFSデータでは停車時間は直接取得できないが、各バス停での遅延情報と区間走行時間が取得可能
• 2.2. 気象データ
    ◦ データソース: バンクーバー地域の気象観測データ（climate.weather_hourly テーブル）
    ◦ 主要な取得項目:
        ▪ date_time_local: 日付と時刻（現地時間）
        ▪ weather: 天候状態を3つの分類で示す（晴れ:1、曇り:4、雨:10）- cloud_cover_8から算出
        ▪ temperature: 気温（摂氏 ◦C）
        ▪ precipitation: 降水量（mm単位）- relative_humidityとcloud_cover_8から推定
        ▪ relative_humidity: 相対湿度（%）
        ▪ pressure_sea: 海面気圧（hPa）
        ▪ wind_speed: 風速（m/s）
        ▪ visibility: 視程（km）
        ▪ cloud_cover_8: 雲量（8分率）
    ◦ 対象地点: バンクーバー地域全体をカバーする気象観測点のデータ
3. データ前処理
収集した生データをモデル入力に適した形式に変換します。
• 3.1. 参照周波数 (Reference Frequency) の設定
    ◦ バス路線の運行頻度に合わせて、データを集計する時間幅（例: 60分）を設定します。これにより、各時間幅に観測された走行時間と遅延時間が過去運行データの各要素となります。
• 3.2. 特徴量の定義
    ◦ 遅延予測用特徴量: travel_time_duration（走行時間）、arrival_delay（遅延時間）、weather（天候）、temperature（気温）、precipitation（降水量）の5次元の時系列特徴量として結合します。
    ◦ route_id・direction_id別処理: 各路線の各方向（上り・下り）ごとに独立した時系列として処理し、異なる交通パターンを学習します。
    ◦ 気象データの結合: reference frequencyに従って気象データをアップサンプリングまたはダウンサンプリングし、対応する運行データと結合します。畳み込みフィルターとストライドの幅を特徴量の列数（5次元）に設定することで、各時間帯の特徴量を同時に畳み込むことが可能になります。
• 3.3. データ分割
    ◦ データセットを訓練データ（例: 最初の38週間）とテストデータ（例: 最後の1週間）に分割します。ハイパーパラメータチューニングのためには、別途検証データセットを用意することが推奨されます。
    ◦ route_id + direction_id別分割: 各路線の各方向ごとに時系列順序を保持して分割し、異なる路線間でのデータリークを防ぎます。
    ◦ 学習を行う前に、過去運行データをinput timesteps（予測の入力とする過去の時間幅、例: 8）とoutput timesteps（予測を行う未来の時間幅、例: 3）に基づいて分割します（スライディングウィンドウアプローチ）。
• 3.4. 正規化・標準化
    ◦ travel_time_duration: route_id + direction_id + 曜日 + reference frequencyに基づく時間帯ごとの平均値と標準偏差を用いて正規化します。外れ値の影響を避けるため、中央絶対誤差 (Median Absolute Deviation: MAD) を用いて極端な外れ値を除去します。
    ◦ arrival_delay: 同様にroute_id + direction_id別に正規化しますが、負の値（早着）も含むため、ゼロ中心の標準化を行います。
    ◦ weather, temperature, precipitation: 四分位点（第一四分位点Q1、第二四分位点Q2、第三四分位点Q3）を基準に標準化します。
• 3.5. 欠損値補完・異常値処理
    ◦ 運行データ（travel_time_duration）: 負の値は物理的に不可能なため除外し、10秒未満・3600秒以上の異常値も除外します。
    ◦ 遅延データ（arrival_delay）: 極端な値（±3600秒以上）は除外しますが、正常な範囲内の早着・遅延は保持します。
    ◦ 欠損値が発生した場合、同一route_id + direction_id + 時間帯の直前の観測値で置換 (Last Observation Carried Forward: LOCF) します。
4. モデルアーキテクチャの設計
提案手法のモデルは、PetersenらのConvolutional LSTMベースのアーキテクチャを元に設計されています。
  4.1. 選定理由
   - バス遅延データが持つ空間的特徴（路線、バス停の位置など）と時間的特徴（時間
     帯、曜日の推移など）の両方を同時に扱えるため、高い精度が期待できる。
   - 論文「... (論文名) ...」でも有効性が示されている。

  4.2. 必要となる特徴量（インプットデータ）
   - 時間軸: [何を時間ステップとするか。例: 10分ごとのスナップショット]
   - 空間軸: [何を空間情報とするか。例: 路線をグリッド化 or
     バス停ごとの特徴量マップ]
   - 具体的な特徴: [例: 各グリッド/バス停における平均遅延時間、バスの台数など]
• 4.1. 全体構造:
    ◦ エンコーダ・デコーダ構造: それぞれ2層のConvolutional LSTM層で構成されます。
    ◦ Bidirectional LSTMの適用: 全ての4層のConvolutional LSTM層にBidirectional LSTMを適用します。
    ◦ 正則化: 過学習を防ぐため、各Convolutional LSTM層間にDropout層とBatch Normalization層を適用します。Dropout率はPetersenらの研究で20%, 10%, 10%が調整されている例がありますが、自身のデータでチューニングが必要です。Batch Normalizationは活性化関数への入力の妥当性を確保し、学習を高速化します。
    ◦ 活性化関数: ConvLSTM層では線形活性化関数を使用し、デコーダブロックの最終層（全結合層）では遅延時間予測では線形活性化関数、走行時間予測ではReLU活性化関数を使用します。
• 4.2. エンコーダの処理
    ◦ 1層目のConvolutional LSTMの畳み込みフィルターの幅とストライドを5（特徴量数: travel_time_duration, arrival_delay, weather, temperature, precipitation）に合わせて設定します。これにより、過去運行データと気象データを同時に畳み込むことが可能になります。
    ◦ 2層目のConvolutional LSTMでは最後のtimestepの出力のみを取得し、Flatten層で平滑化してデコーダへ渡します。
• 4.3. デコーダの処理
    ◦ エンコーダからの入力に対してoutput timestepsの数だけ複製を行うRepeatVector処理を行い、複数先の遅延時間予測を可能にします。
    ◦ その後、エンコーダと同様に2層のConvolutional LSTM層とDropout、Batch Normalization層を経由します。
    ◦ 最後のTimeDistributed層で、遅延時間（arrival_delay）の最終的な予測を行います。遅延は正負両方の値を取るため線形活性化関数を使用します。
• 4.4. 最適化と損失関数
    ◦ 最適化: RMSprop。
    ◦ 損失関数: 平均二乗誤差 (Mean Squared Error: MSE)。
• 4.5. 実装環境: TensorFlow 2.1.0上にPythonで構築されたKerasライブラリが使用されました。
5. モデル学習
• 5.1. ハイパーパラメータチューニング
    ◦ HyperBandなどの自動チューニングツールを用いて、最適なハイパーパラメータ（Batchsize、Dropout rate、Filters、Kernel size 0、Kernel size 1、Learning rateなど）を探索します。
    ◦ 検証データセットに対する平均二乗誤差 (MSE) をValidation Lossとして用います。
• 5.2. 学習実行:
    ◦ 準備した訓練データを用いて、設計したモデル（遅延時間予測用の1つのモデル）を学習させます。
    ◦ route_id + direction_id別のデータバランスを考慮し、必要に応じてclass weightingやオーバーサンプリングを適用します。
6. 予測と評価
• 6.1. 遅延時間の予測
    ◦ 学習済みモデルで予測された遅延時間を基に、時刻表からの乗り場所における予測到着時刻を算出します。
    ◦ 遅延時間の予測値: 負の値は早着、正の値は遅延を表します。
• 6.2. 評価指標
    ◦ RMSE (Root Mean Squared Error): 平均化された誤差。
    ◦ MAE (Mean Absolute Error): 平均化された誤差。
    ◦ MAPE (Mean Absolute Percentage Error): 観測値に対する相対的な誤差。
    ◦ これらの指標を用いて、テストデータセットに対するモデルの予測精度を評価します。
• 6.3. 評価シナリオ
    ◦ 1週間全体の遅延予測精度: 全体的なモデル性能を評価します。
    ◦ ピーク時間帯の遅延予測精度: 運行が不安定になりやすい時間帯（例: 朝ラッシュ7-9時、夕ラッシュ17-19時）での性能を評価します。
    ◦ 雨天時の運行乱れ時の遅延予測精度: 気象情報を取り込んだ効果を検証するために、雨天で運行が大きく乱れた日の性能を評価します。
    ◦ 天候が安定しているが運行が一部乱れた日の評価: 天候以外の要因による乱れへの対応を評価します。
    ◦ 天候と運行が安定した日の評価: 通常時の安定した運行における性能を評価します。
    ◦ route_id + direction_id別評価: 路線・方向別の予測精度を分析し、特定路線での性能課題を特定します。
• 6.4. 比較対象:
    ◦ 提案手法の性能を、Historical Average (HA)、PureLSTM、ConvLSTMといった既存手法と比較します。
    ◦ さらに、単純な遅延時間の移動平均予測とも比較し、気象情報統合の効果を検証します。

--------------------------------------------------------------------------------

## バンクーバーデータ特有の考慮事項

### データ制約と対応策
• **停車時間データなし**: 原論文では走行時間と停車時間を個別予測していましたが、バンクーバーのGTFSデータでは停車時間が直接取得できません。代替として遅延時間を予測目標とし、時刻表との差分から実用的な到着予測を行います。

• **route_id + direction_id対応**: バンクーバーでは複数路線・複数方向のデータが利用可能です。上り・下りで大きく異なる交通パターン（朝ラッシュは郊外→都心、夕ラッシュは都心→郊外が混雑）を学習します。

• **データ品質管理**: GTFSリアルタイムデータには負の走行時間など異常値が含まれるため、SQLレベルでの前処理と統計的外れ値除去を実装します。

### 予測精度への影響
• **精度低下要因**: 停車時間の欠如により、原論文と比較して予測精度が低下する可能性があります。
• **補完アプローチ**: 遅延時間には停車時間の影響も間接的に含まれるため、より多くの履歴データと詳細な気象情報で精度向上を図ります。
• **実用性重視**: 精度よりも実用性を重視し、バス利用者が必要とする「何分遅れるか」の情報提供に特化します。